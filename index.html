<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>-NINE Büí£MB-</title>
<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  background: #222;
  color: #fff;
  margin: 0;
  padding: 0;
  touch-action: manipulation;
}
h1 {
  font-size: calc(20px + 2vw);
  margin-top: 10px;
}
#grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  gap: 5px;
  width: 90vw;
  max-width: 300px;
  aspect-ratio: 1 / 1;
  margin: 10px auto;
}
.cell {
  background: #ccc;
  border-radius: 8px;
  transition: background 0.2s;
}
#status {
  font-size: calc(16px + 0.5vw);
  margin: 5px 0;
}
#controller {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-top: 10px;
}
#dpad {
  display: grid;
  grid-template-columns: repeat(3, 60px);
  grid-template-rows: repeat(3, 60px);
  gap: 5px;
}
.control-btn {
  font-size: 1.5em;
  border: none;
  border-radius: 10px;
  background: #2196F3;
  color: #fff;
  cursor: pointer;
}
.control-btn:active {
  background: #1976D2;
}
#bombBtn, #resetBtn {
  display: block;
  width: 70px;
  height: 70px;
  margin: 5px auto;
  border: none;
  border-radius: 10px;
  font-size: 1em;
  color: white;
  cursor: pointer;
}
#bombBtn {
  background: #FF4C4C;
}
#resetBtn {
  background: #777;
}
</style>
</head>
<body>
<h1>-NINE Büí£MB-</h1>

<div id="grid"></div>

<div id="status"></div>

<div id="controller">
  <div id="dpad">
    <div></div> <!-- ‰∏ä -->
    <button class="control-btn" data-dir="up">‚Üë</button>
    <div></div>
    <button class="control-btn" data-dir="right">‚Üí</button>
    <div></div> <!-- Áúü„Çì‰∏≠Á©∫ÁôΩ -->
    <button class="control-btn" data-dir="left">‚Üê</button>
    <div></div>
    <button class="control-btn" data-dir="down">‚Üì</button>
    <div></div>
  </div>
  <div>
    <button id="bombBtn">BOMB</button>
    <button id="resetBtn">RESET</button>
  </div>
</div>

<script>
const gridSize = 3;
let playerPos = {x:2, y:2};
let enemyPos = {x:0, y:0};
let bombPositions = [];
let gameStarted = false;
let gameOver = false;
let enemyPause = false;
let moveInterval;
let enemyBombCooldown = 0;
let playerVisible = true;
let wins = 0, losses = 0;

const grid = document.getElementById("grid");
const statusDiv = document.getElementById("status");

function createGrid(){
  grid.innerHTML = "";
  for(let i=0;i<gridSize*gridSize;i++){
    const cell = document.createElement("div");
    cell.className = "cell";
    grid.appendChild(cell);
  }
  renderCharacters();
}

function renderCharacters(){
  const cells = document.querySelectorAll(".cell");
  cells.forEach(c => { c.style.background = "#ccc"; });

  bombPositions.forEach(b => {
    const idx = b.y*gridSize + b.x;
    cells[idx].style.background = "#FFEB3B";
  });

  if(!gameOver || (gameOver && !playerVisible)){
    const eIdx = enemyPos.y*gridSize + enemyPos.x;
    cells[eIdx].style.background = "#E91E63";
  }

  if(playerVisible){
    const pIdx = playerPos.y*gridSize + playerPos.x;
    cells[pIdx].style.background = "#4CAF50";
  }
}

function canMove(x, y){
  if(x<0 || x>=gridSize || y<0 || y>=gridSize) return false;
  if(bombPositions.some(p=>p.x===x && p.y===y)) return false;
  if(gameOver) return false;
  return true;
}

function move(direction){
  if(!gameStarted) return;
  let newX = playerPos.x, newY = playerPos.y;
  if(direction==="up") newY--;
  if(direction==="down") newY++;
  if(direction==="left") newX--;
  if(direction==="right") newX++;
  if(canMove(newX,newY) && !(newX===enemyPos.x && newY===enemyPos.y)){
    playerPos = {x:newX, y:newY};
  }
  renderCharacters();
}

function placeBomb(pos=playerPos){
  if(!gameStarted || gameOver) return;
  if(bombPositions.some(p=>p.x===pos.x && p.y===pos.y)) return;
  bombPositions.push({...pos});
  renderCharacters();

  enemyPause = true;
  moveEnemyStep(2);

  setTimeout(()=>explode(pos.x,pos.y),700);
}

function moveEnemyStep(steps){
  if(steps<=0){
    setTimeout(()=>{enemyPause=false;},500);
    return;
  }
  const dirs = [{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}].sort(()=>Math.random()-0.5);
  for(let dir of dirs){
    let nx = enemyPos.x + dir.x;
    let ny = enemyPos.y + dir.y;
    if(canMove(nx, ny) && !(nx===playerPos.x && ny===playerPos.y)){
      enemyPos = {x:nx, y:ny};
      renderCharacters();
      setTimeout(()=>moveEnemyStep(steps-1),250);
      break;
    }
  }
}

function explode(x,y){
  const cells=document.querySelectorAll(".cell");
  const dirs=[[0,0],[-1,0],[1,0],[0,-1],[0,1]];
  dirs.forEach(([dx,dy])=>{
    const r=y+dy;
    const c=x+dx;
    if(r>=0 && r<gridSize && c>=0 && c<gridSize){
      const idx = r*gridSize + c;
      cells[idx].style.background="#FFFF66";
    }
  });

  if(dirs.some(([dx,dy])=>playerPos.x===x+dx && playerPos.y===y+dy)){
    gameOver=true;
    playerVisible=false;
    losses++;
    statusDiv.textContent=`GAME OVER„ÄÄ${wins} WIN / ${losses} LOSE`;
  }
  if(dirs.some(([dx,dy])=>enemyPos.x===x+dx && enemyPos.y===y+dy)){
    gameOver=true;
    wins++;
    statusDiv.textContent=`NICE GAME!„ÄÄ${wins} WIN / ${losses} LOSE`;
  }

  setTimeout(()=>{
    bombPositions = bombPositions.filter(b=>!(b.x===x && b.y===y));
    renderCharacters();
    if(gameOver) resetPositions();
  },300);
}

function moveEnemyRandom(){
  if(gameOver || enemyPause) return;
  const dirs = [{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}].sort(()=>Math.random()-0.5);
  for(let dir of dirs){
    let nx = enemyPos.x + dir.x;
    let ny = enemyPos.y + dir.y;
    if(canMove(nx, ny) && !(nx===playerPos.x && ny===playerPos.y)){
      enemyPos = {x:nx, y:ny};
      break;
    }
  }
  renderCharacters();
  if(enemyBombCooldown<=0){
    placeBomb(enemyPos);
    enemyBombCooldown=3;
  }else enemyBombCooldown--;
}

function startGame(){
  playerPos={x:2,y:2};
  enemyPos={x:0,y:0};
  bombPositions=[];
  gameStarted=true;
  gameOver=false;
  enemyPause=false;
  playerVisible=true;
  statusDiv.textContent=`${wins} WIN / ${losses} LOSE`;
  renderCharacters();
  clearInterval(moveInterval);
  moveInterval=setInterval(moveEnemyRandom,500);
}

function resetPositions(){
  clearInterval(moveInterval);
  gameStarted=false;
  setTimeout(()=>{
    playerPos={x:2,y:2};
    enemyPos={x:0,y:0};
    bombPositions=[];
    playerVisible=true;
    renderCharacters();
  },500);
}

// „Ç§„Éô„É≥„ÉàË®≠ÂÆö
document.querySelectorAll(".control-btn").forEach(btn=>{
  btn.addEventListener("click",()=>move(btn.dataset.dir));
});
document.getElementById("bombBtn").addEventListener("click",()=>{
  if(!gameStarted) startGame();
  else placeBomb();
});
document.getElementById("resetBtn").addEventListener("click",()=>{
  wins=0; losses=0;
  startGame();
});

document.addEventListener("keydown",e=>{
  if(e.key==="Enter") startGame();
  if(!gameStarted || gameOver) return;
  if(e.key==="ArrowUp") move("up");
  if(e.key==="ArrowDown") move("down");
  if(e.key==="ArrowLeft") move("left");
  if(e.key==="ArrowRight") move("right");
  if(e.key===" ") placeBomb();
});

createGrid();

// --- „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Ç∫„Éº„É†Á¶ÅÊ≠¢ ---
let lastTouchEnd = 0;
document.addEventListener('touchend', function(event) {
  const now = new Date().getTime();
  if (now - lastTouchEnd <= 300) event.preventDefault();
  lastTouchEnd = now;
}, false);
</script>
</body>
</html>
